<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrightPattern 인증 테스트 - BP_Sample14</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .card {
            margin-bottom: 20px;
        }
        .response-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.875rem;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-loading { background-color: #ffc107; }
        .btn-loading {
            position: relative;
            color: transparent;
        }
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }
        @keyframes button-loading-spinner {
            from { transform: rotate(0turn); }
            to { transform: rotate(1turn); }
        }
        /* ===== Compact Layout 추가 ===== */
        body { font-size:14px; }
        .card { margin-bottom:12px; }
        .compact-input .form-control{ padding:.25rem .5rem; font-size:.75rem; }
        /* 인증 카드 sticky */
        .sticky-auth { position:sticky; top:56px; z-index:20; }
        @media (max-width: 992px){ .sticky-auth { top: 56px; } }
        /* 로그 드로어 */
        .bp-log-drawer { position:fixed; left:0; right:0; bottom:0; background:#0d1117; color:#d0d6dc; font-family:ui-monospace,monospace; border-top:1px solid #30363d; display:flex; flex-direction:column; max-height:60vh; transition:height .18s ease; box-shadow:0 -2px 8px rgba(0,0,0,.25); }
        .bp-log-drawer.collapsed { height:30px; }
        .bp-log-drawer:not(.collapsed){ height:220px; }
        .bp-log-drawer .log-header { display:flex; align-items:center; justify-content:space-between; padding:4px 8px; background:#161b22; font-size:12px; }
        .bp-log-drawer .log-actions button { font-size:11px; background:#30363d; color:#d0d6dc; border:1px solid #3a4047; padding:2px 6px; margin-left:4px; cursor:pointer; }
        .bp-log-drawer .log-actions button:hover { background:#3a4047; }
        .bp-log-drawer .log-body { flex:1; overflow:auto; padding:4px 8px; }
        .bp-log-drawer pre { margin:0; font-size:11px; line-height:1.3; white-space:pre-wrap; word-break:break-word; }
        .bp-log-drawer.collapsed .log-body { display:none; }
        .bp-log-drawer .log-resizer { position:absolute; top:0; left:0; right:0; height:5px; cursor:ns-resize; transform:translateY(-100%); }
        /* 상태 인디케이터 위치 조정 */
        #status-indicator { vertical-align:middle; }
        .response-box { max-height:260px; }
    </style>
</head>
<body>
    <div class="container mt-3">
        <!-- hidden auth state carrier -->
        <div id="bp-auth-state" th:data-authenticated="${tokenInfo != null ? tokenInfo.authenticated : false}"></div>

        <!-- ===== 인증 테스트 (최상단, sticky) ===== -->
        <div class="card sticky-auth" id="auth-card">
            <div class="card-header bg-primary text-white py-2">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                    <div class="d-flex align-items-center gap-2">
                        <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>BrightPattern 인증 테스트</h6>
                        <span id="status-indicator" class="status-indicator"></span>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-success btn-sm" onclick="performAuth()"><i class="fas fa-sign-in-alt me-1"></i>인증</button>
                        <button class="btn btn-info btn-sm" onclick="checkAuthStatus()"><i class="fas fa-check-circle me-1"></i>상태</button>
                        <button class="btn btn-secondary btn-sm" onclick="getTokenInfo()"><i class="fas fa-info-circle me-1"></i>토큰</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearResponse()"><i class="fas fa-times me-1"></i>지우기</button>
                    </div>
                </div>
            </div>
            <div class="card-body py-2">
                <div class="row g-2 small" th:if="${tokenInfo}">
                    <div class="col-md-3 col-6"><strong>인증 URL:</strong><br><code th:text="${tokenInfo.authUrl}">-</code></div>
                    <div class="col-md-3 col-6"><strong>테넌트 URL:</strong><br><code th:text="${tokenInfo.tenantUrl}">-</code></div>
                    <div class="col-md-2 col-6"><strong>사용자명:</strong><br><code th:text="${tokenInfo.username}">-</code></div>
                    <div class="col-md-4 col-6"><strong>OAuth Token:</strong><br><code th:text="${tokenInfo.oauthAccessTokenMasked} ?: '-'">-</code></div>
                    <div class="col-md-2 col-6 mt-2"><strong>세션:</strong><br><code th:text="${tokenInfo.sessionPresent}">false</code></div>
                    <div class="col-md-3 col-6 mt-2" th:if="${#maps.containsKey(tokenInfo,'sessionToken')}"><strong>세션 토큰:</strong><br><code th:text="${#strings.substring(tokenInfo.sessionToken,0,12)} + '...'">-</code></div>
                </div>
                <div class="mt-2">
                    <div id="response-container" class="response-box small">테스트를 시작하려면 위의 버튼을 클릭하세요.</div>
                </div>
            </div>
        </div>

        <!-- ===== 구독 생성 / 데이터 조회 (아래로 이동) ===== -->
        <div class="card mb-3" id="subscription-create-card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-bell me-2"></i>구독 생성</h6>
            </div>
            <div class="card-body">
                <!-- 변경 전: 단일 DTO 폼만 존재 -->
                <!--
                <form id="subscription-form" onsubmit="createSubscription(event)">
                    <div class="mb-2">
                        <label class="form-label">Team ID</label>
                        <input type="text" class="form-control" id="teamId" placeholder="팀 UUID" required disabled>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Limit</label>
                        <input type="number" class="form-control" id="limit" value="1000" disabled>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Columns (comma separated statName)</label>
                        <input type="text" class="form-control" id="columns" value="first_last_name,user_id,team_id,team_name,login_id,is_agent,extension,acd_next_state,login_time,acd_state" disabled>
                    </div>
                    <button class="btn btn-primary" type="submit" disabled>구독 생성</button>
                </form>
                -->
                <!-- 수정 후: DTO / Raw JSON 탭 -->
                <ul class="nav nav-tabs" id="subTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="dto-tab" data-bs-toggle="tab" data-bs-target="#dtoPane" type="button" role="tab">DTO 방식</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="raw-tab" data-bs-toggle="tab" data-bs-target="#rawPane" type="button" role="tab">Raw JSON 방식</button>
                    </li>
                </ul>
                <div class="tab-content border border-top-0 p-3">
                    <!-- DTO Pane -->
                    <div class="tab-pane fade show active" id="dtoPane" role="tabpanel">
                        <form id="subscription-form" onsubmit="createSubscription(event)">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label small">Team ID</label>
                                    <input type="text" class="form-control compact-input" id="teamId" placeholder="팀 UUID" required disabled>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Limit</label>
                                    <input type="number" class="form-control compact-input" id="limit" value="1000" disabled>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Columns (comma separated statName)</label>
                                <input type="text" class="form-control" id="columns" value="first_last_name,user_id,team_id,team_name,login_id,is_agent,extension,acd_next_state,login_time,acd_state" disabled>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" type="submit" disabled id="btn-create-dto">구독 생성</button>
                                <button type="button" class="btn btn-outline-secondary" disabled id="btn-copy-to-raw" onclick="fillSampleRawFromDto()">Raw JSON 채우기</button>
                            </div>
                        </form>
                    </div>
                    <!-- Raw JSON Pane -->
                    <div class="tab-pane fade" id="rawPane" role="tabpanel">
                        <div class="mb-2">
                            <label class="form-label d-flex justify-content-between align-items-center">Raw JSON
                                <span class="small text-muted">루트에 '1' 키 포함 형식</span>
                            </label>
                            <textarea class="form-control" id="rawJson" rows="10" placeholder='{"1":{"agent_grids":[...]}}' spellcheck="false" disabled></textarea>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-warning" id="btn-validate-raw" type="button" disabled onclick="validateRawJson()">구문 검사</button>
                            <button class="btn btn-success" id="btn-create-raw" type="button" disabled onclick="createSubscriptionRaw()">Raw 구독 생성</button>
                            <button class="btn btn-outline-secondary" id="btn-clear-raw" type="button" disabled onclick="document.getElementById('rawJson').value=''">지우기</button>
                        </div>
                        <div class="form-text mt-2" id="raw-validation-msg"></div>
                    </div>
                </div>
            </div>
        </div>
        <!--div class="card mb-3" id="subscription-data-card">
            <div class="card-header"><h6 class="mb-0"><i class="fas fa-database me-2"></i>구독 데이터 조회</h6></div>
            <div class="card-body">
                <button class="btn btn-outline-primary" onclick="fetchSubscriptionData()" id="btn-data" disabled>데이터 가져오기</button>
            </div>
        </div-->
    </div>

    <!-- ===== 하단 로그 드로어 ===== -->
    <div class="bp-log-drawer collapsed" id="logDrawer">
        <div class="log-resizer" id="logResizer"></div>
        <div class="log-header">
            <span class="fw-semibold">로그</span>
            <div class="log-actions">
                <button id="logCollapseBtn">▲</button>
                <button id="logClearBtn">Clear</button>
            </div>
        </div>
        <div class="log-body" id="logBody">
            <pre id="logLines">[LOG] 초기화됨</pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const responseContainer = document.getElementById('response-container');
        const statusIndicator = document.getElementById('status-indicator');
        let subscriptionFetchInterval = null;
        let subscriptionFetchCount = 0;

        function setStatus(status) {
            statusIndicator.className = `status-indicator status-${status}`;
        }

        function setLoading(button) {
            button.classList.add('btn-loading');
            button.disabled = true;
            setStatus('loading');
        }

        function clearLoading() {
            document.querySelectorAll('.btn-loading').forEach(btn => {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            });
        }

        function setSubscriptionEnabled(enabled){
            document.querySelectorAll('#subscription-form input, #subscription-form button').forEach(el=>{
                el.disabled = !enabled;
            });
            const dataBtn = document.getElementById('btn-data');
            if (dataBtn) dataBtn.disabled = !enabled;
        }

        function clearSubscriptionInterval(){
            if(subscriptionFetchInterval){
                clearInterval(subscriptionFetchInterval);
                subscriptionFetchInterval = null;
            }
            subscriptionFetchCount = 0;
        }

        // 기존 updateResponse 확장: meta(요청정보) 포함 가능
        function updateResponse(data, isError = false, meta = null) {
            const timestamp = new Date().toLocaleString();
            const statusClass = isError ? 'text-danger' : 'text-success';
            let formattedData;
            try {
                if (typeof data === 'string') {
                    const parsed = JSON.parse(data);
                    formattedData = JSON.stringify(parsed, null, 2);
                } else {
                    formattedData = JSON.stringify(data, null, 2);
                }
            } catch (e) {
                formattedData = data;
            }
            let metaBlock = '';
            if(meta){
                metaBlock = `<div class="small text-muted mb-2"><strong>요청정보</strong> | method=${meta.method} url=${meta.url} attempt=${meta.attempt} trigger=${meta.trigger} at=${meta.time}</div>`;
                if(meta.extra){ metaBlock += `<div class="small text-muted">${meta.extra}</div>`; }
            }
            responseContainer.innerHTML = `
                <div class="${statusClass} mb-2"><strong>${isError ? '❌' : '✅'} ${timestamp}</strong></div>
                ${metaBlock}
                <pre class="mb-0">${formattedData}</pre>
            `;
            setStatus(isError ? 'error' : 'success');
        }

        // 초기 비활성화 후 토큰 정보에 sessionToken 있으면 활성화
        window.addEventListener('DOMContentLoaded', ()=>{
            const el = document.getElementById('bp-auth-state');
            const auth = el && el.dataset.authenticated === 'true';
            setSubscriptionEnabled(auth);
        });

        async function performAuth() {
            const button = event.target;
            setLoading(button);
            try {
                const response = await fetch('/api/brightpattern/auth', { method: 'POST' });
                const dataText = await response.text();
                if (response.ok) {
                    updateResponse(dataText);
                    const infoRes = await fetch('/api/brightpattern/auth/info');
                    if (infoRes.ok) {
                        const info = await infoRes.json();
                        if (info.authenticated) { setSubscriptionEnabled(true); }
                    }
                } else {
                    updateResponse(`HTTP ${response.status}: ${dataText}`, true);
                }
            } catch (e) {
                updateResponse(`네트워크 오류: ${e.message}`, true);
            } finally { clearLoading(); }
        }

        async function checkAuthStatus() {
            const button = event.target;
            setLoading(button);
            
            try {
                const response = await fetch('/api/brightpattern/auth/status');
                const data = await response.text();
                
                if (response.ok) {
                    updateResponse(data);
                } else {
                    updateResponse(`HTTP ${response.status}: ${data}`, true);
                }
            } catch (error) {
                updateResponse(`네트워크 오류: ${error.message}`, true);
            } finally {
                clearLoading();
            }
        }

        async function getTokenInfo() {
            const button = event.target;
            setLoading(button);
            try {
                const response = await fetch('/api/brightpattern/auth/info');
                const data = await response.json();
                if (response.ok) {
                    updateResponse(data);
                    if (data.authenticated) { setSubscriptionEnabled(true); }
                } else {
                    updateResponse(`HTTP ${response.status}: ${JSON.stringify(data)}`, true);
                }
            } catch (error) {
                updateResponse(`네트워크 오류: ${error.message}`, true);
            } finally { clearLoading(); }
        }

        async function createSubscription(e){
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            setLoading(btn);
            const teamId = document.getElementById('teamId').value.trim();
            const limit = parseInt(document.getElementById('limit').value,10) || 1000;
            const columnsInput = document.getElementById('columns').value.split(',').map(s=>s.trim()).filter(Boolean);
            const columns = columnsInput.map((name,idx)=>({ id: String(idx+1), statName: name }));
            const body = { agent_grids: [ { id: "1", team_ids: [teamId], limit, columns, order: [{ by: "1", dir: "DESC" }], service_ids: [], my_subteam_only: false, logged_in_agents_only: false } ] };
            try {
                const res = await fetch('/api/brightpattern/subscriptions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const txt = await res.text();
                updateResponse(txt, !res.ok, {method:'POST', url:'/api/brightpattern/subscriptions', attempt:1, trigger:'manual', time:new Date().toLocaleTimeString()});
                if(res.ok){
                    // 구독 성공 시 자동 주기 조회 설정
                    clearSubscriptionInterval();
                    // 즉시 1회 실행 후 30초마다
                    fetchSubscriptionData('auto-initial');
                    subscriptionFetchInterval = setInterval(()=> fetchSubscriptionData('auto'), 30000);
                }
            } catch(err){
                updateResponse('구독 생성 오류: '+err.message, true, {method:'POST', url:'/api/brightpattern/subscriptions', attempt:1, trigger:'manual', time:new Date().toLocaleTimeString()});
            } finally { clearLoading(); }
        }

        async function fetchSubscriptionData(trigger='manual'){
            const btn = document.getElementById('btn-data');
            if(trigger==='manual') setLoading(btn);
            const attempt = ++subscriptionFetchCount;
            const meta = {method:'GET', url:'/api/brightpattern/subscriptions/data', attempt, trigger, time:new Date().toLocaleTimeString()};
            try {
                const res = await fetch('/api/brightpattern/subscriptions/data');
                const txt = await res.text();
                updateResponse(txt, !res.ok, meta);
            } catch(e){
                updateResponse('데이터 조회 오류: '+e.message, true, meta);
            } finally { if(trigger==='manual') clearLoading(); }
        }

        function clearResponse() {
            responseContainer.innerHTML = '응답이 지워졌습니다.';
            setStatus('');
        }

        const logDrawer = document.getElementById('logDrawer');
        const logCollapseBtn = document.getElementById('logCollapseBtn');
        const logClearBtn = document.getElementById('logClearBtn');
        const logLinesEl = document.getElementById('logLines');
        const logBody = document.getElementById('logBody');

        function appendLog(line){
            if(!logLinesEl) return;
            const ts = new Date().toLocaleTimeString();
            logLinesEl.textContent += `\n[${ts}] ${line}`;
            const body = document.getElementById('logBody');
            body.scrollTop = body.scrollHeight;
        }

        logCollapseBtn.addEventListener('click', ()=>{
            logDrawer.classList.toggle('collapsed');
            logCollapseBtn.textContent = logDrawer.classList.contains('collapsed') ? '▲' : '▼';
        });
        logClearBtn.addEventListener('click', ()=>{ if(logLinesEl) logLinesEl.textContent=''; });

        // 드로어 리사이즈
        let resizing=false, startY=0, startH=0;
        logResizer.addEventListener('mousedown', (e)=>{ if(logDrawer.classList.contains('collapsed')) return; resizing=true; startY=e.clientY; startH=logDrawer.getBoundingClientRect().height; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', (e)=>{ if(!resizing) return; const dy = startY - e.clientY; let newH = Math.min(Math.max(startH + dy, 100), window.innerHeight*0.6); logDrawer.style.height = newH + 'px'; });
        window.addEventListener('mouseup', ()=>{ if(resizing){ resizing=false; document.body.style.userSelect=''; }});

        // 기존 updateResponse 확장: 로그에도 누적
        const _origUpdateResponse = updateResponse; // 기존 참조 (이미 선언된 함수 앞부분 주석 표시)
        updateResponse = function(data, isError=false, meta=null){
            _origUpdateResponse(data, isError, meta); // 기존 동작 (response-container 교체)
            try{
                const shortMeta = meta ? `${meta.method} ${meta.url} (${meta.trigger||''})` : '';
                let text; if(typeof data==='string'){ text=data.substring(0,400); } else { text=JSON.stringify(data).substring(0,400); }
                appendLog(`${isError?'ERR':'OK '} ${shortMeta} :: ${text.replace(/\n/g,' ')}`);
            }catch(e){ appendLog('LOG Append 실패: '+e.message); }
        };

        // 수정 후: Raw JSON 필드까지 활성화
        (function(){
            const originalSetSubscriptionEnabled = window.setSubscriptionEnabled;
            window.setSubscriptionEnabled = function(enabled){
                originalSetSubscriptionEnabled(enabled);
                ['rawJson','btn-validate-raw','btn-create-raw','btn-clear-raw','btn-copy-to-raw','btn-create-dto'].forEach(id=>{
                    const el=document.getElementById(id); if(el) el.disabled = !enabled;
                });
            };
        })();

        // DTO 본문 구성 분리
        function buildDtoBody(){
            const teamId = document.getElementById('teamId').value.trim();
            const limit = parseInt(document.getElementById('limit').value,10) || 1000;
            const columnsInput = document.getElementById('columns').value.split(',').map(s=>s.trim()).filter(Boolean);
            const columns = columnsInput.map((name,idx)=>({ id: String(idx+1), statName: name }));
            return { agent_grids: [ { id: "1", team_ids: [teamId], limit, columns, order: [{ by: "1", dir: "DESC" }], service_ids: [], my_subteam_only: false, logged_in_agents_only: false } ] };
        }

        // Raw JSON 채우기: DTO 값 기반 wrapper 형식
        function fillSampleRawFromDto(){
            try {
                const dto = buildDtoBody();
                const raw = { "1": { agent_grids: dto.agent_grids } };
                document.getElementById('rawJson').value = JSON.stringify(raw, null, 2);
                document.getElementById('raw-validation-msg').textContent = 'DTO 값으로 Raw JSON이 채워졌습니다.';
                document.getElementById('raw-validation-msg').className = 'form-text text-success';
            } catch(e){
                document.getElementById('raw-validation-msg').textContent = '채우기 실패: '+ e.message;
                document.getElementById('raw-validation-msg').className = 'form-text text-danger';
            }
        }

        function validateRawJson(){
            const area = document.getElementById('rawJson');
            const msg = document.getElementById('raw-validation-msg');
            const text = area.value.trim();
            if(!text){ msg.textContent='내용이 비어 있습니다.'; msg.className='form-text text-danger'; return; }
            try {
                const parsed = JSON.parse(text);
                // 최소 구조 검사
                if(!parsed['1'] || !Array.isArray(parsed['1'].agent_grids)) throw new Error("'1.agent_grids' 배열이 필요합니다.");
                if(parsed['1'].agent_grids.length===0) throw new Error('agent_grids 배열이 비어 있습니다.');
                msg.textContent='구문 및 1차 구조 OK';
                msg.className='form-text text-success';
            } catch(e){
                msg.textContent='검사 실패: '+e.message;
                msg.className='form-text text-danger';
            }
        }

        async function createSubscriptionRaw(){
            const btn = document.getElementById('btn-create-raw');
            btn.classList.add('btn-loading'); btn.disabled = true;
            const metaBase = {method:'POST', url:'/api/brightpattern/subscriptions/raw', attempt:1, trigger:'manual-raw', time:new Date().toLocaleTimeString()};
            try {
                const text = document.getElementById('rawJson').value;
                if(!text.trim()) { updateResponse('Raw JSON이 비어 있습니다.', true, metaBase); return; }
                try { JSON.parse(text); } catch(e){ updateResponse('JSON 파싱 오류: '+e.message, true, metaBase); return; }
                const res = await fetch('/api/brightpattern/subscriptions/raw', { method:'POST', headers:{'Content-Type':'application/json'}, body:text });
                const bodyTxt = await res.text();
                updateResponse(bodyTxt, !res.ok, metaBase);
                if(res.ok){ clearSubscriptionInterval(); fetchSubscriptionData('auto-initial'); subscriptionFetchInterval = setInterval(()=>fetchSubscriptionData('auto'), 30000); }
            } catch(e){
                updateResponse('Raw 구독 생성 실패: '+e.message, true, metaBase);
            } finally {
                btn.classList.remove('btn-loading'); btn.disabled=false;
            }
        }

        // 기존 createSubscription 함수는 buildDtoBody 사용하도록 재정의 (원본 주석 보존)
        // 변경 전:
        // async function createSubscription(e){ ... columnsInput.map ... fetch('/api/brightpattern/subscriptions', ...) }
        // 수정 후:
        const originalCreateSubscription = window.createSubscription;
        window.createSubscription = async function(e){
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            setLoading(btn);
            const metaBase = {method:'POST', url:'/api/brightpattern/subscriptions', attempt:1, trigger:'manual-dto', time:new Date().toLocaleTimeString()};
            try {
                const body = buildDtoBody();
                const res = await fetch('/api/brightpattern/subscriptions', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
                const txt = await res.text();
                updateResponse(txt, !res.ok, metaBase);
                if(res.ok){ clearSubscriptionInterval(); fetchSubscriptionData('auto-initial'); subscriptionFetchInterval = setInterval(()=>fetchSubscriptionData('auto'), 30000); }
            } catch(err){
                updateResponse('구독 생성 오류: '+err.message, true, metaBase);
            } finally { clearLoading(); }
        };
    </script>
</body>
</html>
